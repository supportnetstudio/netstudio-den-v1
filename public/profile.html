<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MUSE â€” Stylist Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --bg: #ffffff;
      --text: #000000;
      --accent: #2563eb;
      --border: #000000;
      --font-display: 'Oswald', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    /* --- RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg); color: var(--text);
      font-family: var(--font-body); line-height: 1.5;
      max-width: 480px; margin: 0 auto; /* App-width limit */
      min-height: 100vh; position: relative;
      border-left: 1px solid #eee; border-right: 1px solid #eee;
    }

    /* --- NAVIGATION --- */
    .top-bar {
      padding: 20px; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border);
      position: relative; top: auto; background: white; z-index: 50;
    }
    .brand-mini { font-family: var(--font-display); font-weight: 700; font-size: 20px; letter-spacing: -0.05em; }
    .back-btn { 
      font-size: 11px; font-weight: 600; text-transform: uppercase; 
      text-decoration: none; color: var(--text); display: flex; align-items: center; gap: 4px; 
    }

    /* Loading: prevent placeholder flash */
    body.ns-loading .profile-hero,
    body.ns-loading .specs-grid,
    body.ns-loading .action-stack,
    body.ns-loading .portfolio-header,
    body.ns-loading .grid-feed,
    body.ns-loading .mini-footer { opacity: 0; }

    body:not(.ns-loading) .profile-hero,
    body:not(.ns-loading) .specs-grid,
    body:not(.ns-loading) .action-stack,
    body:not(.ns-loading) .portfolio-header,
    body:not(.ns-loading) .grid-feed,
    body:not(.ns-loading) .mini-footer {
      opacity: 1;
      transition: opacity .18s ease;
    }

    /* --- HERO --- */
    .profile-hero {
      position: relative;
    }
    .profile-img {
      width: 100%; aspect-ratio: 3/4; object-fit: cover; filter: grayscale(100%);
      border-bottom: 1px solid var(--border);
    }
    
    .name-overlay {
      background: var(--text); color: var(--bg); padding: 16px 20px;
    }
    .stylist-name {
      font-family: var(--font-display); font-size: 48px; text-transform: uppercase; line-height: 0.9;
    }
    .stylist-role {
      font-family: var(--font-body); font-size: 12px; font-weight: 600; 
      text-transform: uppercase; letter-spacing: 0.1em; color: #ccc; margin-top: 4px;
    }

    /* --- SPECS --- */
    .specs-grid {
      display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border);
    }
    .spec-item {
      padding: 16px 20px; border-right: 1px solid var(--border);
    }
    .spec-item:last-child { border-right: none; }
    
    .spec-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; display: block; margin-bottom: 4px; }
    .spec-val { font-family: var(--font-display); font-size: 18px; text-transform: uppercase; }

    /* --- ACTIONS --- */
    .action-stack { padding: 20px; display: flex; flex-direction: column; gap: 12px; border-bottom: 1px solid var(--border); }
    
    .btn-main {
      background: var(--accent); color: white; text-align: center;
      padding: 18px; font-weight: 700; text-transform: uppercase; font-size: 14px;
      text-decoration: none; letter-spacing: 0.05em; border: none; cursor: pointer;
    }
    .btn-main:hover { opacity: 0.9; }

    .btn-row { display: flex; gap: 12px; }
    .btn-sec {
      flex: 1; border: 1px solid var(--border); background: transparent; color: var(--text);
      padding: 12px; text-align: center; font-size: 12px; font-weight: 600; text-transform: uppercase;
      text-decoration: none; transition: 0.2s;
    }
    .btn-sec:hover { background: var(--text); color: white; }

    /* --- PORTFOLIO --- */
    .portfolio-header {
      padding: 20px; font-family: var(--font-display); font-size: 24px; text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }
    
    .grid-feed {
      display: grid; grid-template-columns: 1fr 1fr;
    }
    .feed-item {
      aspect-ratio: 1/1; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
      position: relative; overflow: hidden;
    }
    .feed-item:nth-child(even) { border-right: none; }
    
    .feed-img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); transition: 0.3s; }
    .feed-item:hover .feed-img { filter: grayscale(0%); transform: scale(1.05); }

    /* --- FOOTER --- */
    .mini-footer {
      padding: 40px 20px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;
    }

  </style>
</head>
<body class="ns-loading">

  <div class="top-bar">
    <a href="#" class="back-btn" id="btn_back"><i data-lucide="arrow-left" style="width:14px"></i> Roster</a>
    <div class="brand-mini">MUSE.</div>
  </div>

  <div class="profile-hero">
    <img id="profile_avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" class="profile-img" alt="">
    <div class="name-overlay">
      <h1 class="stylist-name" id="profile_name"></h1>
      <div class="stylist-role" id="profile_role" style="display:none;"></div>
      <div style="margin-top:10px; font-size:12px; opacity:.85; display:none;" id="profile_bio"></div>
      <div style="margin-top:10px; display:none; align-items:center; gap:6px;" id="profile_handle_wrap">
        <i data-lucide="instagram" style="width:14px"></i>
        <a id="profile_ig_link" href="#" target="_blank" rel="noopener"
           style="color:#fff; text-decoration:none; font-size:12px; font-weight:600;"></a>
      </div>
    </div>
  </div>

  <div class="specs-grid" id="specs_grid" style="display:none;">
    <div class="spec-item">
      <span class="spec-label">Specialty</span>
      <span class="spec-val" id="spec_specialty"></span>
    </div>
    <div class="spec-item">
      <span class="spec-label">Experience</span>
      <span class="spec-val" id="spec_experience"></span>
    </div>
  </div>

  <div class="action-stack">
    <button class="btn-main" id="btn_book">
      Book Appointment
    </button>
    <div class="btn-row">
      <a href="#" class="btn-sec" id="btn_instagram" style="display:none;">Instagram</a>
      <a href="#" class="btn-sec" id="btn_tiktok" style="display:none;">TikTok</a>
    </div>
  </div>

  <div class="portfolio-header">Recent Works</div>
  <div class="grid-feed" id="mini_gallery">
    <div style="grid-column:1/-1; padding:16px 20px; font-size:12px; opacity:.6;">Loading photos...</div>
  </div>

  <div class="mini-footer">
    Represented by <span id="shop_badge_name">MUSE</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // booking stub (kept simple; you said booking later)
    window.openBooking = window.openBooking || function(){ console.log("Open booking"); };

    function nsGetSlugFromHost() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
      const host = (location.hostname || "").toLowerCase();
      if (!host || host === "localhost" || host.startsWith("127.")) return null;
      const ROOT = "netstudiodevelopment.com";
      if (host === ROOT || host === "www." + ROOT) return null;
      if (host.endsWith("." + ROOT)) return host.slice(0, -(ROOT.length + 1)).split(".")[0] || null;
      return null;
    }

    function nsShouldUseQuerySlug() {
      const host = (location.hostname || "").toLowerCase();
      return (host.endsWith(".pages.dev") || host.endsWith(".workers.dev") || host === "localhost" || host.startsWith("127."));
    }

    async function nsResolveBusinessSlug() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
      const fromHost = nsGetSlugFromHost();
      if (fromHost) return fromHost;
      try {
        const r = await fetch("/__site", { cache: "no-store" });
        if (!r.ok) return null;
        const j = await r.json();
        return (j?.slug || "").trim().toLowerCase() || null;
      } catch { return null; }
    }

    function nsReadPublicSlug() {
      const q = new URLSearchParams(location.search).get("public_slug");
      if (q) return String(q).trim();
      const m = (location.pathname || "").match(/^\/team\/([^\/?#]+)\/?$/);
      if (m) return decodeURIComponent(m[1]);
      return null;
    }

    function nsTeamLink() {
      if (nsShouldUseQuerySlug()) {
        const u = new URL("team.html", location.href);
        const b = new URLSearchParams(location.search).get("b");
        if (b) u.searchParams.set("b", b);
        return u.pathname + "?" + u.searchParams.toString();
      }
      return "/team";
    }

    window.NS = {
      SUPABASE_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
      BUSINESS_SLUG: null
    };

    const sb = supabase.createClient(window.NS.SUPABASE_URL, window.NS.SUPABASE_ANON_KEY);

    function setText(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      const v = (val == null) ? "" : String(val);
      el.textContent = v;
    }

    function show(id, display="block") {
      const el = document.getElementById(id);
      if (el) el.style.display = display;
    }

    async function loadProfile() {
      const bizSlug = await nsResolveBusinessSlug();
      window.NS.BUSINESS_SLUG = bizSlug;
      const publicSlug = nsReadPublicSlug();
      if (!bizSlug || !publicSlug) { location.href = nsTeamLink(); return; }

      // Back button
      const back = document.getElementById("btn_back");
      if (back) back.onclick = (e) => { e.preventDefault(); location.href = nsTeamLink(); };

      // Business
      const { data: biz, error: bErr } = await sb
        .from("business")
        .select("id,name")
        .eq("slug", bizSlug)
        .maybeSingle();
      if (bErr || !biz?.id) { location.href = nsTeamLink(); return; }
      setText("shop_badge_name", (biz.name || "MUSE").toUpperCase());

      // Team member
      const { data: tm, error: tErr } = await sb
        .from("team_members")
        .select("id,name,role,bio,photo_url,public_slug,instagram_handle,specialties")
        .eq("business_id", biz.id)
        .eq("public_slug", publicSlug)
        .maybeSingle();
      if (tErr || !tm?.id) { location.href = nsTeamLink(); return; }

      // Text blocks
      setText("profile_name", tm.name || "");
      const roleText = (tm.role || "").trim();
      if (roleText) { setText("profile_role", roleText); show("profile_role","block"); }

      const bioText = (tm.bio || "").trim();
      if (bioText) { setText("profile_bio", bioText); show("profile_bio","block"); }

      const spec = (tm.specialties || "").trim();
      if (spec) { setText("spec_specialty", spec); show("specs_grid","grid"); }

      // Avatar priority: gallery_image profile -> team_members.photo_url
      let avatarUrl = (tm.photo_url || "").trim();
      const { data: avatarRow } = await sb
        .from("gallery_image")
        .select("image_url,created_at")
        .eq("business_id", biz.id)
        .eq("team_member_id", tm.id)
        .eq("type", "team")
        .eq("is_profile", true)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();
      if (avatarRow?.image_url) avatarUrl = avatarRow.image_url;
      if (avatarUrl) document.getElementById("profile_avatar").src = avatarUrl;

      // Instagram handle
      const ig = (tm.instagram_handle || "").trim().replace(/^@/, "");
      if (ig) {
        const igA = document.getElementById("profile_ig_link");
        if (igA) {
          igA.textContent = "@" + ig;
          igA.href = `https://www.instagram.com/${encodeURIComponent(ig)}/`;
        }
        show("profile_handle_wrap","flex");

        const igBtn = document.getElementById("btn_instagram");
        if (igBtn) {
          igBtn.href = `https://www.instagram.com/${encodeURIComponent(ig)}/`;
          igBtn.target = "_blank";
          igBtn.rel = "noopener";
          show("btn_instagram","block");
        }
      }

      // Booking button (kept stubby)
      const bookBtn = document.getElementById("btn_book");
      if (bookBtn) bookBtn.onclick = (e) => { e.preventDefault(); window.openBooking({ staff_id: tm.id }); };

      // Gallery (team photos, not profile)
      const galleryEl = document.getElementById("mini_gallery");
      const { data: works } = await sb
        .from("gallery_image")
        .select("image_url,created_at")
        .eq("business_id", biz.id)
        .eq("team_member_id", tm.id)
        .eq("type", "team")
        .eq("is_profile", false)
        .order("created_at", { ascending: false })
        .limit(12);

      if (galleryEl) {
        const imgs = (works || []).map(r => r.image_url).filter(Boolean);
        galleryEl.innerHTML = "";
        if (!imgs.length) {
          galleryEl.innerHTML = `<div style="grid-column:1/-1; padding:16px 20px; font-size:12px; opacity:.6;">No recent work yet.</div>`;
        } else {
          imgs.forEach((url) => {
            const cell = document.createElement("div");
            cell.className = "feed-item";
            const img = document.createElement("img");
            img.className = "feed-img";
            img.loading = "lazy";
            img.src = url;
            cell.appendChild(img);
            galleryEl.appendChild(cell);
          });
        }
      }

      // reveal
      requestAnimationFrame(() => document.body.classList.remove("ns-loading"));
    }

    (async () => {
      if (window.lucide) lucide.createIcons();
      await loadProfile();
      if (window.lucide) lucide.createIcons();
    })();
  </script>
</body>
</html>
