<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barber Profile — Net Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script>
    // Fallback if JS fails or loads late
    window.openBooking = window.openBooking || function () {
      console.warn("Booking engine initializing...");
    };
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    :root {
      --bg-body: #050507;
      --bg-card: #141414;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --accent: #ef4444; 
      --border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', sans-serif;
      --radius: 16px;
    }

    /* Reset & Global Guard */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      width: 100%; 
      background: var(--bg-body); 
      color: var(--text-main);
      font-family: var(--font-body);
      overflow-x: hidden;
    }

    /* App Wrapper: Constrains content without breaking background */
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      background: var(--bg-body);
    }

    img { max-width: 100%; height: auto; display: block; }

    /* --- PROFILE HEADER --- */
    .profile-header {
      background: linear-gradient(to bottom, rgba(0,0,0,0), var(--bg-body)), 
                  url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=800');
      background-size: cover; background-position: center;
      padding: 60px 20px 20px; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .avatar-frame {
      width: 110px; height: 110px; margin: 0 auto 16px;
      padding: 4px; background: var(--bg-card);
      border-radius: 50%; border: 1px solid var(--border);
    }
    .avatar {
      width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
      border: 2px solid var(--accent);
    }
    .barber-name { font-size: 24px; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.02em; }
    
    /* Role Styling */
    .barber-role {
      font-size: 13px; color: var(--accent); font-weight: 700; 
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; 
      display: flex; align-items: center; justify-content: center; gap: 4px;
    }

    /* Handle Styling */
    .barber-handle { 
      font-size: 13px; color: var(--text-muted); font-weight: 600; 
      margin-bottom: 16px; display: inline-flex; align-items: center; gap: 4px;
    }
    
    .action-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;
    }
    .action-btn {
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text-main); text-decoration: none;
      padding: 12px; border-radius: 12px; font-size: 12px; font-weight: 600;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary {
      grid-column: span 2; background: var(--accent); color: white; border: none;
      font-size: 14px; font-weight: 700; padding: 16px; text-transform: uppercase;
    }

    .bio-text { font-size: 14px; color: var(--text-muted); margin-bottom: 30px; line-height: 1.6; }
    .stats-row {
      display: flex; justify-content: space-around; padding: 20px 0;
      border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
    }
    .stat-val { font-size: 18px; font-weight: 800; display: block; }
    .stat-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; }

    .mini-gallery {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 40px;
    }
    .gallery-img {
      width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px;
      opacity: 0.8; transition: 0.2s; cursor: pointer;
    }
    .gallery-img:hover { opacity: 1; }

    .review-pill {
      background: var(--bg-card); border: 1px solid var(--border);
      padding: 16px; border-radius: 12px; margin-bottom: 12px;
    }

    /* Sticky badge with safe-area support */
    .shop-badge {
      position: fixed; 
      bottom: calc(20px + env(safe-area-inset-bottom)); 
      left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border);
      font-size: 11px; color: var(--text-muted); text-decoration: none;
      display: flex; align-items: center; gap: 8px; z-index: 100;
    }
    .shop-badge span { color: white; font-weight: 700; }

  </style>
</head>
<body data-barber-id="" data-business-id="">

  <div class="app-container">
    <header class="profile-header">
      <div class="avatar-frame">
        <img id="profile_avatar" src="https://images.unsplash.com/photo-1605497788044-5a32c7078486?w=400" class="avatar" alt="Barber">
      </div>
      
      <h1 class="barber-name" id="profile_name">...</h1>
      
      <div class="barber-role" id="profile_role">
        <span id="profile_role_text"></span>
      </div>

      <div class="barber-handle" id="profile_handle_wrap" style="display:none;">
        <i data-lucide="instagram" style="width:12px"></i> 
        <span id="profile_handle">@...</span>
      </div>
      
      <div class="bio-text" id="profile_bio">
        Loading profile...
      </div>

      <div class="action-grid">
        <a href="#" class="action-btn btn-primary" onclick="openBooking(); return false;">
          Book Appointment
        </a>
        <a href="#" class="action-btn"><i data-lucide="camera" style="width:14px"></i> Portfolio</a>
        <a href="#" class="action-btn"><i data-lucide="dollar-sign" style="width:14px"></i> Tip Jar</a>
      </div>
    </header>

    <div class="stats-row">
      <div class="stat-item"><span class="stat-val">5.0</span><span class="stat-label">Rating</span></div>
      <div class="stat-item"><span class="stat-val">--</span><span class="stat-label">Cuts</span></div>
      <div class="stat-item"><span class="stat-val">--</span><span class="stat-label">Exp</span></div>
    </div>

    <div style="padding: 0 20px;">
      <h3 style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; color: var(--text-muted);">Recent Work</h3>
      <div class="mini-gallery">
        <img src="https://images.unsplash.com/photo-1621605815971-fbc98d665033?w=300" class="gallery-img">
        <img src="https://images.unsplash.com/photo-1599351431202-1e0f0137899a?w=300" class="gallery-img">
        <img src="https://images.unsplash.com/photo-1503951914875-befbb711ed3e?w=300" class="gallery-img">
      </div>

      <h3 style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; color: var(--text-muted);">Client Love</h3>
      <div class="review-pill">
        <p style="font-size:13px; font-style:italic; opacity:0.8;">"Best cuts in the city."</p>
        <div style="font-size:10px; margin-top:8px; opacity:0.5;">— Client</div>
      </div>
    </div>

    <a href="#" class="shop-badge" id="shop_badge">
      Powered by <span id="shop_badge_name">THE DEN</span>
    </a>

    <div style="height: 100px;"></div> 
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- helpers ----------
    function nsGetSlugFromHost() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
  
      const host = (location.hostname || "").toLowerCase();
      if (!host || host === "localhost" || host.startsWith("127.")) return null;
  
      const ROOT = "netstudiodevelopment.com";
      if (host === ROOT || host === "www." + ROOT) return null;
  
      if (host.endsWith("." + ROOT)) {
        const slug = host.slice(0, -(ROOT.length + 1)).split(".")[0];
        return slug || null;
      }
      return null;
    }
  
    function nsShouldUseQuerySlug() {
      const host = (location.hostname || "").toLowerCase();
      return (
        host.endsWith(".pages.dev") ||
        host.endsWith(".workers.dev") ||
        host === "localhost" ||
        host.startsWith("127.")
      );
    }
  
    async function nsResolveBusinessSlug() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
  
      const fromHost = nsGetSlugFromHost();
      if (fromHost) return fromHost;
  
      // custom domain path: ask router
      try {
        const r = await fetch("/__site", { cache: "no-store" });
        if (!r.ok) return null;
        const j = await r.json();
        return (j?.slug || "").trim().toLowerCase() || null;
      } catch {
        return null;
      }
    }
  
    function nsReadPublicSlug() {
      // 1) query param wins
      const q = new URLSearchParams(location.search).get("public_slug");
      if (q) return String(q).trim();
  
      // 2) production route: /team/<public_slug>
      const m = (location.pathname || "").match(/^\/team\/([^\/?#]+)\/?$/);
      if (m) return decodeURIComponent(m[1]);
  
      return null;
    }
  
    function nsTeamLink() {
      // preview: team.html?b=slug
      if (nsShouldUseQuerySlug()) {
        const u = new URL("team.html", location.href);
        const b = new URLSearchParams(location.search).get("b");
        if (b) u.searchParams.set("b", b);
        return u.pathname + "?" + u.searchParams.toString();
      }
      // production: /team
      return "/team";
    }
  
    // ---------- config ----------
    window.NS = {
      SUPABASE_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
      BUSINESS_SLUG: null
    };
  
    const sb = supabase.createClient(window.NS.SUPABASE_URL, window.NS.SUPABASE_ANON_KEY);
  
    // ---------- render ----------
    function setText(id, val) {
      const el = document.getElementById(id);
      if (el && val != null && String(val).trim() !== "") el.textContent = String(val);
    }
    function setImage(id, src, alt) {
      const el = document.getElementById(id);
      if (!el) return;
      if (src) el.src = src;
      if (alt) el.alt = alt;
    }
  
    async function loadProfile() {
      const bizSlug = await nsResolveBusinessSlug();
      window.NS.BUSINESS_SLUG = bizSlug;
  
      const publicSlug = nsReadPublicSlug();
      if (!bizSlug || !publicSlug) {
        // fail safe: kick them back to team page
        location.href = nsTeamLink();
        return;
      }
  
      // find business
      const { data: biz, error: bErr } = await sb
        .from("business")
        .select("id,name")
        .eq("slug", bizSlug)
        .maybeSingle();
  
      if (bErr || !biz?.id) {
        location.href = nsTeamLink();
        return;
      }
  
      // find team member by public_slug
      const { data: tm, error: tErr } = await sb
        .from("team_members")
        .select("id,name,role,bio,photo_url,public_slug,instagram_handle")
        .eq("business_id", biz.id)
        .eq("public_slug", publicSlug)
        .maybeSingle();
  
      if (tErr || !tm?.id) {
        location.href = nsTeamLink();
        return;
      }
  
      // profile pic priority:
      // 1) gallery_image where is_profile=true
      // 2) team_members.photo_url
      let avatarUrl = tm.photo_url || "";
      const { data: pic } = await sb
        .from("gallery_image")
        .select("image_url,created_at")
        .eq("business_id", biz.id)
        .eq("team_member_id", tm.id)
        .eq("is_profile", true)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();
  
      if (pic?.image_url) avatarUrl = pic.image_url;
  
      // fill UI (DB-backed only)
      setText("profile_name", tm.name || "Barber");
      setText("profile_bio", tm.bio || "");
      
      // role (optional)
      setText("profile_role_text", tm.role || "");
      
      // hide role line if empty
      const roleWrap = document.getElementById("profile_role");
      if (roleWrap && !(tm.role || "").trim()) roleWrap.style.display = "none";

      // avatar
      setImage("profile_avatar", avatarUrl, tm.name || "Barber");
      
      // stamp dataset attributes
      document.body.dataset.barberId = tm.id;
      document.body.dataset.businessId = biz.id;

      // instagram handle logic
      const ig = (tm.instagram_handle || "").trim();
      const igWrap = document.getElementById("profile_handle_wrap");
      const igText = document.getElementById("profile_handle");

      if (igWrap && igText) {
        if (!ig) {
          igWrap.style.display = "none";
        } else {
          igWrap.style.display = "inline-flex";
          igText.textContent = ig.startsWith("@") ? ig : ("@" + ig);
        }
      }
  
      // footer badge back to team page
      const badge = document.getElementById("shop_badge");
      if (badge) badge.href = nsTeamLink();
      setText("shop_badge_name", (biz.name || "").toUpperCase());
  
      // hook booking to staff_id
      window.openBooking = window.openBooking || function(){};
      window.openBookingWithStaff = function() {
        window.openBooking({ staff_id: tm.id });
      };
  
      // make the main button use staff booking
      const btn = document.querySelector(".btn-primary");
      if (btn) btn.onclick = function(e){ e.preventDefault(); window.openBookingWithStaff(); };
    }
  
    (async () => {
      await loadProfile();
      if (window.lucide) lucide.createIcons();
    })();
  </script>

</body>
</html>
