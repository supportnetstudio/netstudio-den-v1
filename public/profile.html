<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barber Profile â€” Net Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script>
    // Fallback if JS fails or loads late
    window.openBooking = window.openBooking || function (options) {
      console.warn("Booking engine initializing...", options);
    };
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    :root {
      --bg-body: #050507;
      --bg-card: #141414;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --accent: #ef4444; 
      --border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', sans-serif;
      --radius: 16px;
    }

    /* Reset & Global Guard */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      width: 100%; 
      background: var(--bg-body); 
      color: var(--text-main);
      font-family: var(--font-body);
      overflow-x: hidden;
    }

    /* App Wrapper */
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      background: var(--bg-body);
    }

    img { max-width: 100%; height: auto; display: block; }

    /* --- PROFILE HEADER --- */
    .profile-header {
      background: linear-gradient(to bottom, rgba(0,0,0,0), var(--bg-body)), 
                  url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=800');
      background-size: cover; background-position: center;
      padding: 60px 20px 20px; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .avatar-frame {
      width: 110px; height: 110px; margin: 0 auto 16px;
      padding: 4px; background: var(--bg-card);
      border-radius: 50%; border: 1px solid var(--border);
    }
    .avatar {
      width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
      border: 2px solid var(--accent);
    }
    .barber-name { font-size: 24px; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.02em; }
    
    /* Role Styling */
    .barber-role {
      font-size: 13px; color: var(--accent); font-weight: 700; 
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; 
      display: flex; align-items: center; justify-content: center; gap: 4px;
    }

    /* Handle Styling */
    .barber-handle { 
      font-size: 13px; color: var(--text-muted); font-weight: 600; 
      margin-bottom: 16px; display: inline-flex; align-items: center; gap: 4px;
    }
    
    /* Action Buttons */
    .action-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;
    }
    .action-btn {
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text-main); text-decoration: none;
      padding: 12px; border-radius: 12px; font-size: 12px; font-weight: 600;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    /* Primary button spans full width on row 1 */
    .btn-primary {
      grid-column: span 2; background: var(--accent); color: white; border: none;
      font-size: 14px; font-weight: 700; padding: 16px; text-transform: uppercase;
    }

    .bio-text { font-size: 14px; color: var(--text-muted); margin-bottom: 30px; line-height: 1.6; }

    /* Gallery */
    .mini-gallery {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 40px;
    }
    .gallery-img {
      width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px;
      opacity: 0.9; transition: 0.2s; cursor: pointer;
    }
    .gallery-img:hover { opacity: 1; }

    /* Sticky badge */
    .shop-badge {
      position: fixed; 
      bottom: calc(20px + env(safe-area-inset-bottom)); 
      left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border);
      font-size: 11px; color: var(--text-muted); text-decoration: none;
      display: flex; align-items: center; gap: 8px; z-index: 100;
    }
    .shop-badge span { color: white; font-weight: 700; }

  </style>
</head>
<body data-barber-id="" data-business-id="">

  <div class="app-container">
    <header class="profile-header">
      <div class="avatar-frame">
        <img id="profile_avatar" src="" class="avatar" alt="Barber">
      </div>
      
      <h1 class="barber-name" id="profile_name">...</h1>
      
      <div class="barber-role" id="profile_role_wrap" style="display:none;">
        <span id="profile_role_text"></span>
      </div>

      <div class="barber-handle" id="profile_handle_wrap" style="display:none;">
        <i data-lucide="instagram" style="width:12px"></i> 
        <span id="profile_handle">@...</span>
      </div>
      
      <div class="bio-text" id="profile_bio">
        Loading profile...
      </div>

      <div class="action-grid">
        <a href="#" class="action-btn btn-primary" id="btn_book">
          Book Appointment
        </a>
        
        <a href="#" class="action-btn" id="btn_instagram" style="display:none;">
          <i data-lucide="instagram" style="width:14px"></i> Instagram
        </a>
        <a href="#" class="action-btn" id="btn_tiktok" style="display:none;">
          <i data-lucide="video" style="width:14px"></i> TikTok
        </a>
      </div>
    </header>

    <div style="padding: 0 20px;">
      <h3 style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; color: var(--text-muted);">Recent Work</h3>
      <div class="mini-gallery" id="mini_gallery">
        <div style="grid-column:1/-1; opacity:.55; font-size:12px;">Loading photos...</div>
      </div>
    </div>

    <a href="#" class="shop-badge" id="shop_badge">
      Powered by <span id="shop_badge_name">THE DEN</span>
    </a>

    <div style="height: 100px;"></div> 
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- helpers ----------
    function nsGetSlugFromHost() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
  
      const host = (location.hostname || "").toLowerCase();
      if (!host || host === "localhost" || host.startsWith("127.")) return null;
  
      const ROOT = "netstudiodevelopment.com";
      if (host === ROOT || host === "www." + ROOT) return null;
  
      if (host.endsWith("." + ROOT)) {
        const slug = host.slice(0, -(ROOT.length + 1)).split(".")[0];
        return slug || null;
      }
      return null;
    }
  
    function nsShouldUseQuerySlug() {
      const host = (location.hostname || "").toLowerCase();
      return (
        host.endsWith(".pages.dev") ||
        host.endsWith(".workers.dev") ||
        host === "localhost" ||
        host.startsWith("127.")
      );
    }
  
    async function nsResolveBusinessSlug() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
  
      const fromHost = nsGetSlugFromHost();
      if (fromHost) return fromHost;
  
      // custom domain path
      try {
        const r = await fetch("/__site", { cache: "no-store" });
        if (!r.ok) return null;
        const j = await r.json();
        return (j?.slug || "").trim().toLowerCase() || null;
      } catch {
        return null;
      }
    }
  
    function nsReadPublicSlug() {
      // 1) query param wins
      const q = new URLSearchParams(location.search).get("public_slug");
      if (q) return String(q).trim();
  
      // 2) production route: /team/<public_slug>
      const m = (location.pathname || "").match(/^\/team\/([^\/?#]+)\/?$/);
      if (m) return decodeURIComponent(m[1]);
  
      return null;
    }
  
    function nsTeamLink() {
      if (nsShouldUseQuerySlug()) {
        const u = new URL("team.html", location.href);
        const b = new URLSearchParams(location.search).get("b");
        if (b) u.searchParams.set("b", b);
        return u.pathname + "?" + u.searchParams.toString();
      }
      return "/team";
    }
  
    // ---------- config ----------
    window.NS = {
      SUPABASE_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
      BUSINESS_SLUG: null
    };
  
    const sb = supabase.createClient(window.NS.SUPABASE_URL, window.NS.SUPABASE_ANON_KEY);
  
    function setText(id, val) {
      const el = document.getElementById(id);
      if (el && val != null && String(val).trim() !== "") el.textContent = String(val);
    }
    
    function setImage(id, src) {
      const el = document.getElementById(id);
      if (el && src) el.src = src;
    }
  
    async function loadProfile() {
      const bizSlug = await nsResolveBusinessSlug();
      window.NS.BUSINESS_SLUG = bizSlug;
  
      const publicSlug = nsReadPublicSlug();
      if (!bizSlug || !publicSlug) {
        location.href = nsTeamLink();
        return;
      }
  
      // 1. Get Business
      const { data: biz, error: bErr } = await sb
        .from("business")
        .select("id,name")
        .eq("slug", bizSlug)
        .maybeSingle();
  
      if (bErr || !biz?.id) {
        location.href = nsTeamLink();
        return;
      }

      // Update footer badge
      const badge = document.getElementById("shop_badge");
      if (badge) badge.href = nsTeamLink();
      setText("shop_badge_name", (biz.name || "").toUpperCase());
  
      // 2. Get Team Member (include tiktok_handle)
      const { data: tm, error: tErr } = await sb
        .from("team_members")
        .select("id,name,role,bio,photo_url,public_slug,instagram_handle,tiktok_handle")
        .eq("business_id", biz.id)
        .eq("public_slug", publicSlug)
        .maybeSingle();
  
      if (tErr || !tm?.id) {
        location.href = nsTeamLink();
        return;
      }
  
      // --- A) Basic Info ---
      setText("profile_name", tm.name || "Barber");
      setText("profile_bio", tm.bio || "");
      
      const roleText = (tm.role || "").trim();
      if (roleText) {
        setText("profile_role_text", roleText);
        document.getElementById("profile_role_wrap").style.display = "flex";
      }

      // --- B) Avatar Priority ---
      // 1. gallery_image is_profile=true, 2. photo_url
      let avatarUrl = tm.photo_url || "";
      
      const { data: avatarRow } = await sb
        .from("gallery_image")
        .select("image_url")
        .eq("business_id", biz.id)
        .eq("team_member_id", tm.id)
        .eq("type", "team")
        .eq("is_profile", true)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (avatarRow?.image_url) avatarUrl = avatarRow.image_url;
      // Default fallback if absolutely nothing
      if (!avatarUrl) avatarUrl = "https://images.unsplash.com/photo-1605497788044-5a32c7078486?w=400";
      
      setImage("profile_avatar", avatarUrl);

      // --- C) Instagram ---
      const ig = (tm.instagram_handle || "").trim().replace(/^@/, "");
      const handleWrap = document.getElementById("profile_handle_wrap");
      const handleEl = document.getElementById("profile_handle");
      const igBtn = document.getElementById("btn_instagram");

      if (ig) {
        if (handleWrap) handleWrap.style.display = "inline-flex";
        if (handleEl) handleEl.textContent = "@" + ig;

        if (igBtn) {
          igBtn.style.display = "flex";
          igBtn.href = `https://www.instagram.com/${encodeURIComponent(ig)}/`;
          igBtn.target = "_blank";
          igBtn.rel = "noopener";
        }
      }

      // --- D) TikTok ---
      const tt = (tm.tiktok_handle || "").trim().replace(/^@/, "");
      const ttBtn = document.getElementById("btn_tiktok");
      
      if (tt && ttBtn) {
        ttBtn.style.display = "flex";
        ttBtn.href = `https://www.tiktok.com/@${encodeURIComponent(tt)}`;
        ttBtn.target = "_blank";
        ttBtn.rel = "noopener";
      }

      // --- E) Booking Action ---
      const bookBtn = document.getElementById("btn_book");
      if (bookBtn) {
        bookBtn.onclick = function(e) {
          e.preventDefault();
          if (typeof window.openBooking === "function") {
            window.openBooking({ staff_id: tm.id });
          }
        };
      }

      // --- F) Recent Work (Real Gallery) ---
      const galleryEl = document.getElementById("mini_gallery");
      
      const { data: works, error: gErr } = await sb
        .from("gallery_image")
        .select("image_url, created_at")
        .eq("business_id", biz.id)
        .eq("team_member_id", tm.id)
        .eq("type", "team")
        .eq("is_profile", false)
        .order("created_at", { ascending: false })
        .limit(12);

      if (galleryEl) {
        galleryEl.innerHTML = ""; // Clear loading state

        const imgs = (works || []).map(r => r.image_url).filter(Boolean);

        if (!imgs.length) {
          galleryEl.innerHTML = `<div style="grid-column:1/-1; opacity:.4; font-size:12px;">No recent work yet.</div>`;
        } else {
          imgs.forEach(url => {
            const img = document.createElement("img");
            img.src = url;
            img.className = "gallery-img";
            img.loading = "lazy";
            img.alt = "Barber work";
            galleryEl.appendChild(img);
          });
        }
      }
    }
  
    (async () => {
      await loadProfile();
      if (window.lucide) lucide.createIcons();
    })();
  </script>

</body>
</html>
