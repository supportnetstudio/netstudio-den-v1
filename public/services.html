<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Den — Services</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --bg-dark: #050507;
      --bg-gradient: radial-gradient(circle at top, #1b1b22 0%, #000 100%);
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --accent: #ef4444; 
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* --- RESET & MOBILE GUARD --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body { 
      width: 100%; 
      max-width: 100%; 
      overflow-x: hidden; 
    }
    
    img, iframe { 
      max-width: 100%; 
      height: auto; 
      display: block; 
    }

    body {
      background: var(--bg-gradient);
      color: var(--text-main);
      font-family: var(--font-body);
      line-height: 1.6;
      padding-top: 80px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- UTILITIES --- */
    .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
    
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--accent); color: white;
      padding: 10px 20px; border-radius: 4px;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
      text-decoration: none; font-size: 11px; border: none; cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    
    .section-title {
      font-size: 11px; color: var(--accent); letter-spacing: 0.25em;
      text-transform: uppercase; font-weight: 800; margin-bottom: 10px; display: block;
      text-align: center;
    }
    h2 { font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 40px; }

    /* --- HEADER --- */
    header {
      position: fixed; top: 0; width: 100%; z-index: 100;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--glass-border);
    }

    .nav-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 70px;
    }

    .logo { 
      font-weight: 900; 
      font-size: 20px; 
      text-transform: uppercase; 
      letter-spacing: 0.1em; 
      font-style: italic; 
      display: flex;
      align-items: center;
    }
    .logo span { color: var(--accent); }

    .nav-links {
      display: flex;
      gap: 24px;
    }

    .nav-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
    }

    .nav-links a:hover,
    .nav-links a.active { color: #fff; }

    /* --- MOBILE REFINEMENT --- */
    @media (max-width: 768px) {
      header { padding: 6px 0; }

      .nav-wrap {
        flex-direction: column;
        height: auto;
        gap: 8px;
        padding: 10px 0;
      }

      .logo { font-size: 18px; }

      .nav-links {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 14px;
        width: 100%;
      }

      .nav-links a {
        font-size: 11px;
        letter-spacing: 0.12em;
      }

      .btn {
        margin-top: 6px;
        padding: 8px 14px;
        font-size: 10px;
      }

      body { padding-top: 140px; } 
    }

    /* --- SERVICE LIST STYLES --- */
    main { flex: 1; }
    .service-category { margin-bottom: 40px; }
    .cat-title { 
      font-size: 13px; color: var(--text-muted); text-transform: uppercase; 
      letter-spacing: 0.1em; border-bottom: 1px solid var(--glass-border); 
      padding-bottom: 10px; margin-bottom: 20px; font-weight: 700;
    }

    .service-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px; background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: 8px; margin-bottom: 12px; transition: 0.2s;
    }
    
    @media (min-width: 769px) {
      .service-item:hover { border-color: var(--accent); transform: translateX(5px); }
    }
    
    .svc-name { font-weight: 700; font-size: 16px; color: white; }
    .svc-desc { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .svc-price { font-size: 18px; font-weight: 700; color: var(--accent); }
    .svc-right { display: flex; align-items: center; gap: 20px; }

    footer { 
      border-top: 1px solid var(--glass-border); 
      padding: 60px 0; 
      margin-top: 60px; 
      text-align: center; 
      color: var(--text-muted); 
      font-size: 13px; 
      background: #000;
    }

    @media (max-width: 768px) {
      .service-item { flex-direction: column; align-items: flex-start; gap: 15px; }
      .svc-right { width: 100%; justify-content: space-between; }
    }
    
    /* Notice Box hidden by default until loaded to prevent flash */
    #noticeBox { display: none; }
    #noticeBox.visible { display: block; }
  </style>

  <script>
    window.openBooking = window.openBooking || function () { console.warn("Booking engine not yet loaded."); };
  </script>
</head>
<body>

  <header>
    <div class="container nav-wrap" style="max-width: 1100px;">
      <div class="logo" id="nsLogoWrap">
        <span>Loading...</span>
      </div>

      <nav class="nav-links" aria-label="Primary">
        <a class="nav-link" href="index.html" data-page="index.html">Home</a>
        <a class="nav-link" href="about.html" data-page="about.html">About</a>
        <a class="nav-link" href="services.html" data-page="services.html">Services</a>
        <a class="nav-link" href="gallery.html" data-page="gallery.html">Gallery</a>
        <a class="nav-link" href="team.html" data-page="team.html">Team</a>
        <a class="nav-link" href="contact.html" data-page="contact.html">Contact</a>
      </nav>

      <a href="#" onclick="openBooking(); return false;" class="btn">Book Now</a>
    </div>
  </header>

  <main class="container" style="margin-top: 40px;">
    <span class="section-title" id="svcKicker"></span>
    <h2 id="svcHeading"></h2>

    <div id="servicesMount"></div>

    <div id="noticeBox" style="background: rgba(239, 68, 68, 0.05); border: 1px dashed var(--accent); border-radius: 12px; padding: 30px; text-align: center; margin-top: 60px;">
      <h3 id="svcNoticeTitle" style="color: var(--accent); font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.1em;"></h3>
      <p id="svcNoticeText" style="font-size: 13px; color: var(--text-muted); max-width: 600px; margin: 0 auto; white-space: pre-line;"></p>
    </div>
  </main>

  <footer>
    <div class="container" style="max-width: 1100px;">
      <div id="nsFooterLogo" class="logo" style="justify-content: center; margin-bottom: 20px;"></div>
      <p style="margin-bottom: 10px;">© 2026 The Den Barbershop.</p>
    </div>
  </footer>

  <script>
    /* --- NAV REWRITER --- */
    function nsGetSlugFromHost() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
      const host = (location.hostname || "").toLowerCase();
      if (!host || host === "localhost" || host.startsWith("127.") || host === "netstudiodevelopment.com" || host === "www.netstudiodevelopment.com") return null;
      if (host.endsWith(".netstudiodevelopment.com")) return host.slice(0, -26).split(".")[0] || null;
      return null;
    }
  
    function nsShouldUseQuerySlug() {
      const host = (location.hostname || "").toLowerCase();
      return (host.endsWith(".pages.dev") || host.endsWith(".workers.dev") || host === "localhost" || host.startsWith("127."));
    }
  
    function nsLinkWithSlug(targetPath) {
      const slug = nsGetSlugFromHost();
      if (!slug) return targetPath;
      if (!nsShouldUseQuerySlug()) return targetPath;
      const u = new URL(targetPath, location.href);
      u.searchParams.set("b", slug);
      return u.pathname + "?" + u.searchParams.toString() + u.hash;
    }
  
    function nsWireHeaderNav() {
      document.querySelectorAll("a.nav-link[data-page]").forEach(a => {
        const page = a.getAttribute("data-page") || a.getAttribute("href") || "index.html";
        a.setAttribute("href", nsLinkWithSlug(page));
        const current = (location.pathname.split("/").pop() || "index.html").toLowerCase();
        a.classList.toggle("active", page.toLowerCase() === current);
      });
    }
  
    document.addEventListener("DOMContentLoaded", nsWireHeaderNav);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- SaaS Engine Logic ---
    window.NS = {
      ...(window.NS || {}),
      SUPABASE_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
      BUSINESS_SLUG: nsGetSlugFromHost()
    };

    const sb = window.supabaseClient || window.supabase.createClient(window.NS.SUPABASE_URL, window.NS.SUPABASE_ANON_KEY);
    window.supabaseClient = sb;

    async function nsLoadBusinessId() {
      if (!window.NS.BUSINESS_SLUG) return null;
      const { data, error } = await sb.from("business").select("id").eq("slug", window.NS.BUSINESS_SLUG).maybeSingle();
      if (error || !data) return null;
      window.BUSINESS_ID = data.id;
      return data.id;
    }

    async function nsLoadBusinessBranding() {
      if (!window.NS.BUSINESS_SLUG) return;
      const { data, error } = await sb.from("business").select("name, logo_url").eq("slug", window.NS.BUSINESS_SLUG).maybeSingle();
      if (error || !data) return;
      const logoHTML = data.logo_url ? `<img src="${data.logo_url}" alt="${data.name}" style="height:34px; max-width:180px; object-fit:contain;">` : `<span>${data.name.toUpperCase()}</span>`;
      const wrap = document.getElementById("nsLogoWrap");
      const footerWrap = document.getElementById("nsFooterLogo");
      if (wrap) wrap.innerHTML = logoHTML;
      if (footerWrap) footerWrap.innerHTML = logoHTML;
    }

    // ✅ PATCH 3: PUBLIC SERVICES PAGE READER
    async function nsLoadSiteContent() {
      if (!window.BUSINESS_ID) return;
      
      // 1. Resolve Active Template (default to den_v1 if missing)
      let { data: ptr } = await sb.from('business_sites_one').select('active_template_key').eq('business_id', window.BUSINESS_ID).maybeSingle();
      const key = ptr?.active_template_key || 'den_v1';

      // 2. Fetch Content
      const { data: site } = await sb.from('business_sites').select('content_json').eq('business_id', window.BUSINESS_ID).eq('template_key', key).maybeSingle();
      
      // 3. Extract & Render
      const s = site?.content_json?.services || {};
      const intro = s.intro || {};
      const notice = s.notice || {};

      document.getElementById('svcKicker').textContent = intro.kicker || "";
      document.getElementById('svcHeading').textContent = intro.heading || "";
      
      const nTitle = notice.title || "";
      const nText = notice.text || "";
      
      // Only show Notice Box if content exists
      if (nTitle || nText) {
        document.getElementById('svcNoticeTitle').textContent = nTitle;
        document.getElementById('svcNoticeText').textContent = nText;
        document.getElementById('noticeBox').classList.add('visible');
      }
    }

    async function loadMenuItems() {
      if (!window.BUSINESS_ID) return;
      const { data, error } = await sb.from("menu_items").select("*").eq("business_id", window.BUSINESS_ID).eq("is_active", true);
      if (error) return;
      renderMenuItems(data || []);
    }

    function renderMenuItems(items) {
      const mount = document.getElementById("servicesMount");
      if (!mount) return;
      mount.innerHTML = "";
      if (!items.length) {
        mount.innerHTML = `<div style="text-align:center; color: var(--text-muted); padding: 40px 0;">No services found.</div>`;
        return;
      }
      const groups = {};
      items.forEach(i => { const cat = (i.category || "Other").trim(); (groups[cat] ||= []).push(i); });
      Object.entries(groups).forEach(([cat, svcs]) => {
        const catBlock = document.createElement("div");
        catBlock.className = "service-category";
        catBlock.innerHTML = `<div class="cat-title">${cat}</div>`;
        svcs.forEach(s => {
          const p = s.price_cents ? `$${(s.price_cents/100).toFixed(2)}` : (s.price ? `$${Number(s.price).toFixed(2)}` : "");
          const row = document.createElement("div");
          row.className = "service-item";
          row.innerHTML = `<div><div class="svc-name">${s.name}</div>${s.description ? `<div class="svc-desc">${s.description}</div>` : ""}</div><div class="svc-right"><div class="svc-price">${p}</div><button class="btn" onclick="openBooking('${s.id}')">Book</button></div>`;
          catBlock.appendChild(row);
        });
        mount.appendChild(catBlock);
      });
    }

    function nsLoadBookingScript(){
      const s = document.createElement("script");
      s.src = "/assets/js/netstudio_booking.js";
      s.defer = true;
      document.body.appendChild(s);
    }

    (async () => {
      const id = await nsLoadBusinessId();
      if (id) {
        await nsLoadBusinessBranding();
        await nsLoadSiteContent(); // ✅ Patch 3 Trigger
        await loadMenuItems();
        nsLoadBookingScript();
      }
    })();
  </script>
</body>
</html>
