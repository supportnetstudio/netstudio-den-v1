<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Den — Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --bg-dark: #050507;
      --bg-gradient: radial-gradient(circle at top, #1b1b22 0%, #000 100%);
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --accent: #ef4444; 
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; }
    img, iframe { max-width:100%; height:auto; display:block; }

    body {
      background: var(--bg-gradient);
      color: var(--text-main);
      font-family: var(--font-body);
      line-height: 1.6;
      padding-top: 80px;
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--accent); color: white;
      padding: 10px 20px; border-radius: 99px;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
      text-decoration: none; font-size: 11px; border: none; cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    .section-title {
      font-size: 12px; color: var(--accent); letter-spacing: 0.2em;
      text-transform: uppercase; font-weight: 800; margin-bottom: 10px; display: block;
      text-align: center;
    }
    h2 { font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 40px; }

    header {
      position: fixed; top: 0; width: 100%; z-index: 100;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--glass-border);
    }
    .nav-wrap { display: flex; justify-content: space-between; align-items: center; height: 70px; }

    .logo { 
      font-weight: 900; font-size: 20px; text-transform: uppercase; 
      letter-spacing: 0.1em; font-style: italic;
      text-decoration: none; color: var(--text-main);
    }
    .logo span { color: var(--accent); }

    .nav-links { display: flex; gap: 24px; }
    .nav-links a {
      color: var(--text-muted); text-decoration: none; font-size: 13px;
      font-weight: 500; text-transform: uppercase;
    }
    .nav-links a:hover, .nav-links a.active { color: white; }

    .den-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      padding-bottom: 40px;
    }
    .den-photo {
      height: 350px;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      filter: grayscale(100%) contrast(1.1);
      transition: 0.4s ease;
      position: relative;
      cursor: pointer;
      border: 1px solid var(--glass-border);
      overflow: hidden;
    }
    .den-photo:hover {
      filter: grayscale(0%) contrast(1);
      transform: scale(1.02);
      z-index: 2;
      border-color: var(--accent);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .photo-tag {
      position: absolute; bottom: 10px; left: 10px;
      background: var(--accent); color: white;
      font-size: 10px; font-weight: 700; 
      padding: 6px 12px; text-transform: uppercase;
      opacity: 0; transform: translateY(10px); transition: 0.3s;
      border-radius: 4px;
      max-width: calc(100% - 20px);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .den-photo:hover .photo-tag { opacity: 1; transform: translateY(0); }

    footer {
      border-top: 1px solid var(--glass-border);
      padding: 60px 0;
      margin-top: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    @media (max-width: 768px){
      .nav-links { display:none; }
      .photo-tag { opacity:1; transform:none; }
      .den-photo { filter: grayscale(0%) contrast(1); }
      .den-photo:hover { transform: none; border-color: var(--glass-border); box-shadow: none; }
    }
  </style>

  <script>
    window.openBooking = window.openBooking || function () { console.log("Trigger Booking"); };
    window.closeBooking = window.closeBooking || function () {};
  </script>
</head>

<body>

  <header>
    <div class="container nav-wrap">
      <a href="index.html" class="logo" id="header_logo">THE <span>DEN</span></a>

      <nav class="nav-links" aria-label="Primary">
        <a class="nav-link" href="index.html" data-page="index.html">Home</a>
        <a class="nav-link" href="about.html" data-page="about.html">About</a>
        <a class="nav-link" href="services.html" data-page="services.html">Services</a>
        <a class="nav-link active" href="gallery.html" data-page="gallery.html">Gallery</a>
      </nav>

      <a href="#book" class="btn" style="padding: 8px 16px; font-size: 11px;" onclick="openBooking(); return false;">Book Now</a>
    </div>
  </header>

  <main class="container" style="margin-top: 40px;">
    <span class="section-title" id="gallery_kicker">Our Work</span>
    <h2 id="gallery_heading">Fresh Cuts & Fades</h2>
    <p id="gallery_text" style="text-align:center; color:var(--text-muted); max-width:500px; margin:0 auto 60px;">
      Real clients. Real results. No filters. Hover over an image to see the detail.
    </p>

    <div class="den-gallery" id="gallery_grid"></div>
  </main>

  <footer>
    <div class="container">
      <div style="font-weight:900; font-size:24px; margin-bottom:20px; text-transform:uppercase; font-style:italic;">
        THE <span style="color:var(--accent)">DEN</span>
      </div>
      <p>© 2026 The Den Barbershop. Powered by Net Studio.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* --- NAV REWRITER (WORKER READY) --- */
    function nsGetSlugFromHost() {
      // 1) Preview / Pages / local fallback: ?b=slug
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();
  
      // 2) Production: slug.netstudiodevelopment.com
      const host = (location.hostname || "").toLowerCase();
  
      // Ignore obvious non-slug hosts
      if (!host || host === "localhost" || host.startsWith("127.")) return null;
  
      // If we're on the main domain, no slug
      const ROOT = "netstudiodevelopment.com";
      if (host === ROOT || host === "www." + ROOT) return null;
  
      // If it's a subdomain of ROOT, first label is the slug
      if (host.endsWith("." + ROOT)) {
        const slug = host.slice(0, -(ROOT.length + 1)).split(".")[0];
        return slug || null;
      }
  
      // Otherwise unknown host: no slug
      return null;
    }
  
    function nsShouldUseQuerySlug() {
      const host = (location.hostname || "").toLowerCase();
      return (
        host.endsWith(".pages.dev") ||
        host.endsWith(".workers.dev") ||
        host === "localhost" ||
        host.startsWith("127.")
      );
    }
  
    function nsLinkWithSlug(targetPath) {
      const slug = nsGetSlugFromHost();
      if (!slug) return targetPath;
  
      // Production: clean paths, no ?b=
      if (!nsShouldUseQuerySlug()) return targetPath;
  
      // Preview: keep ?b=slug
      const u = new URL(targetPath, location.href);
      u.searchParams.set("b", slug);
      return u.pathname + "?" + u.searchParams.toString() + u.hash;
    }
  
    function nsWireHeaderNav() {
      const logo = document.getElementById("header_logo");
      if (logo) logo.setAttribute("href", nsLinkWithSlug("index.html"));
  
      document.querySelectorAll("a.nav-link[data-page]").forEach(a => {
        const page = a.getAttribute("data-page") || a.getAttribute("href") || "index.html";
        a.setAttribute("href", nsLinkWithSlug(page));
  
        const current = (location.pathname.split("/").pop() || "index.html").toLowerCase();
        a.classList.toggle("active", page.toLowerCase() === current);
      });
    }
  
    window.NS = {
      SUPABASE_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
      BUSINESS_SLUG: nsGetSlugFromHost(),
      TEMPLATE_KEY: "den_v1"
    };

    /* ---------- HELPERS ---------- */
    const $ = (id) => document.getElementById(id);

    function pick(...vals){
      for (const v of vals) {
        if (v !== undefined && v !== null && String(v).trim() !== "") return String(v);
      }
      return "";
    }

    function normalizeId(x){
      return String(x || "").trim();
    }

    function buildTeamMap(teamJson){
      // team_json expected to be array of members
      const arr = Array.isArray(teamJson) ? teamJson : [];
      const map = new Map();
      arr.forEach(m => {
        const id = normalizeId(m?.id || m?.team_member_id || m?.uuid || "");
        const name = pick(m?.name_toggle, m?.display_name, m?.name, m?.full_name, "");
        if (id) map.set(id, name || id);
      });
      return map;
    }

    function overlayForRow(row, teamMap){
      // If tied to a team member: "Cut by Name"
      const tmId = normalizeId(row?.team_member_id);
      const tmName = tmId ? teamMap.get(tmId) : "";
      if (tmName) return `Cut by ${tmName}`;

      // else fallback to caption (if you want)
      const cap = pick(row?.caption, "");
      if (cap) return cap;

      return "";
    }

    function renderGallery(rows, teamMap){
      const grid = $("gallery_grid");
      if (!grid) return;
      grid.innerHTML = "";

      const list = Array.isArray(rows) ? rows : [];

      // If empty, you can show nothing (clean) OR show placeholders. Keeping it clean:
      if (list.length === 0) {
        grid.innerHTML = `<div style="color:rgba(255,255,255,.65); text-align:center; grid-column:1/-1; padding: 40px 0;">
          No gallery images yet.
        </div>`;
        return;
      }

      list.forEach(r => {
        const url = pick(r?.image_url, "");
        if (!url) return;

        const label = overlayForRow(r, teamMap);
        const safeLabel = label.replace(/</g,"&lt;").replace(/>/g,"&gt;");

        grid.insertAdjacentHTML("beforeend", `
          <div class="den-photo" style="background-image:url('${url.replace(/'/g,"%27")}')">
            ${safeLabel ? `<div class="photo-tag">${safeLabel}</div>` : ``}
          </div>
        `);
      });
    }

    function applyGalleryContent(contentJson){
      const c = contentJson || {};
      const g = c.gallery || {};

      // defaults match your hardcoded ones
      const kicker  = pick(g.kicker, "Our Work");
      const heading = pick(g.heading, "Fresh Cuts & Fades");
      const text    = pick(g.text, "Real clients. Real results. No filters. Hover over an image to see the detail.");

      if ($("gallery_kicker"))  $("gallery_kicker").textContent = kicker;
      if ($("gallery_heading")) $("gallery_heading").textContent = heading;
      if ($("gallery_text"))    $("gallery_text").textContent   = text;
    }

    /* ---------- INIT ---------- */
    (async () => {
      const NS = window.NS;
      const sb = supabase.createClient(NS.SUPABASE_URL, NS.SUPABASE_ANON_KEY);

      nsWireHeaderNav();

      if (!NS.BUSINESS_SLUG) {
        // no slug = nothing to load; leave defaults
        if (window.lucide) lucide.createIcons();
        return;
      }

      // 1) get business (need id + team_json)
      const { data: biz, error: bErr } = await sb
        .schema("public") // Force public schema
        .from("business")
        .select("id, team_json")
        .eq("slug", NS.BUSINESS_SLUG)
        .maybeSingle();

      if (bErr || !biz) {
        if (window.lucide) lucide.createIcons();
        return;
      }

      const teamMap = buildTeamMap(biz.team_json);

      // 2) get site content_json for gallery headings
      const { data: site } = await sb
        .schema("public") // Force public schema
        .from("business_sites")
        .select("content_json")
        .eq("business_id", biz.id)
        .eq("template_key", NS.TEMPLATE_KEY)
        .maybeSingle();

      applyGalleryContent(site?.content_json || {});

      // 3) get gallery rows
      // ✅ PATCH: Correct table name, force schema, AND check is_active
      const { data: rows } = await sb
        .schema("public")
        .from("gallery_image") // Correct singular name
        .select("id, image_url, team_member_id, caption, type, is_profile, created_at")
        .eq("business_id", biz.id)
        .eq("is_active", true) // Added active check
        .order("created_at", { ascending: false });

      renderGallery(rows || [], teamMap);

      if (window.lucide) lucide.createIcons();
    })();
  </script>

  <script src="/assets/js/netstudio_booking.js"></script>
</body>
</html>
