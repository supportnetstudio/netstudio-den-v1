<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gallery â€” Powered by Net Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    /* --- Styles clipped for brevity, identical to the previous 'Den' design --- */
    :root {
      --bg-dark: #050507;
      --bg-gradient: radial-gradient(circle at top, #1b1b22 0%, #000 100%);
      --accent: #ef4444; 
      --text-main: #ffffff;
      --glass-border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', system-ui, -apple-system, sans-serif;
    }
    body { background: var(--bg-gradient); color: var(--text-main); font-family: var(--font-body); padding-top: 80px; }
    .den-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .den-photo { height: 400px; background-size: cover; border-radius: 4px; filter: grayscale(100%); transition: 0.4s; position: relative; cursor: pointer; border: 1px solid var(--glass-border); }
    .den-photo:hover { filter: grayscale(0%); transform: scale(1.02); border-color: var(--accent); }
    .photo-tag { position: absolute; bottom: 15px; left: 15px; background: var(--accent); color: white; padding: 6px 12px; font-size: 10px; font-weight: 700; border-radius: 4px; opacity: 0; transition: 0.3s; }
    .den-photo:hover .photo-tag { opacity: 1; }
    #site-error { display: none; text-align: center; padding: 100px 20px; color: #666; font-size: 14px;}
  </style>
</head>
<body>

  <div id="site-error"><h2>404</h2><p>Gallery not found.</p></div>

  <div id="main-content" style="opacity: 0; transition: opacity 0.5s ease;">
    <main class="container" style="margin-top: 40px;">
      <span class="section-title" id="gallery_kicker"></span>
      <h2 id="gallery_heading"></h2>
      <p id="gallery_text" style="text-align:center; color:var(--text-muted); max-width:500px; margin:0 auto 60px;"></p>
      <div class="den-gallery" id="gallery_grid"></div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const pick = (...vals) => vals.find(v => v !== undefined && v !== null && String(v).trim() !== "") || "";

      function nsDetectSlug() {
        const host = location.hostname.toLowerCase();
        if (host.endsWith(".netstudiodevelopment.com")) return host.split(".")[0];
        return new URLSearchParams(location.search).get("b");
      }

      const NS = {
        SB_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
        SB_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
        SLUG: nsDetectSlug(),
        TEMPLATE: "den_v1" // Matches the check constraint in your schema
      };

      const sb = supabase.createClient(NS.SB_URL, NS.SB_KEY);

      function apply(data, biz, images) {
        const gallery = data.gallery || {};
        
        // Identity from public.business table
        const bName = biz.name || "The Den";
        if($("header_logo")) $("header_logo").textContent = bName;
        
        // Static content from business_sites.content_json
        if($("gallery_kicker"))  $("gallery_kicker").textContent = pick(gallery.kicker, "Our Work");
        if($("gallery_heading")) $("gallery_heading").textContent = pick(gallery.heading, "Fresh Cuts & Fades");
        if($("gallery_text"))    $("gallery_text").textContent   = pick(gallery.text, "Real clients. Real results.");

        // Staff resolution from business.team_json
        const teamArray = Array.isArray(biz.team_json) ? biz.team_json : [];
        const teamMap = new Map(teamArray.map(m => [m.id || m.uuid, m.name || m.display_name]));

        const grid = $("gallery_grid");
        if (grid) {
          grid.innerHTML = images.length ? images.map(img => {
            // Resolve "Cut by" using the team_json map
            const artistName = teamMap.get(img.team_member_id);
            const tag = artistName ? `Cut by ${artistName.split(' ')[0]}` : (img.caption || "");
            return `
              <div class="den-photo" style="background-image:url('${img.image_url}')">
                ${tag ? `<div class="photo-tag">${tag}</div>` : ''}
              </div>`;
          }).join("") : `<p style="grid-column:1/-1; text-align:center; opacity:0.5;">No photos yet.</p>`;
        }
        $("main-content").style.opacity = "1";
      }

      async function init() {
        if (!NS.SLUG) { $("site-error").style.display = "block"; return; }
        
        // 1. Fetch from public.business using your specific schema
        const { data: biz } = await sb.from("business").select("*").eq("slug", NS.SLUG).maybeSingle();
        if (!biz) { $("site-error").style.display = "block"; return; }

        // 2. Fetch site content and specific gallery images
        const [siteRes, imgRes] = await Promise.all([
          sb.from("business_sites").select("content_json").eq("business_id", biz.id).eq("template_key", NS.TEMPLATE).maybeSingle(),
          sb.from("gallery_image").select("*").eq("business_id", biz.id).eq("type", "shop").eq("is_profile", false).order("created_at", { ascending: false })
        ]);

        apply(siteRes.data?.content_json || {}, biz, imgRes.data || []);
      }
      init();
    })();
  </script>
</body>
</html>
