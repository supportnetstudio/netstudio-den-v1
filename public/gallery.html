<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Isolated Gallery Image Logic</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>Check your browser console (F12) for query results.</h2>

  <script>
    // 1. Setup Supabase
    const SUPABASE_URL = "https://jdvdgvolfmvlgyfklbwe.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helper to grab slug for context
    function nsGetSlugFromHost() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return qp.toLowerCase();
      // Fallback for testing if not on netstudio domain
      return "den";
    }
    const BUSINESS_SLUG = nsGetSlugFromHost();

    async function runIsolatedGalleryLogic() {
      console.log("Starting isolated query for: " + BUSINESS_SLUG);

      // Prerequisites: Need Business ID and Team IDs to run the gallery query
      const { data: biz } = await sb.schema("public").from("business").select("id").eq("slug", BUSINESS_SLUG).maybeSingle();
      if (!biz?.id) { console.error("Business not found"); return; }

      const { data: members } = await sb.schema("public").from("team_members").select("id").eq("business_id", biz.id);
      const ids = (members || []).map(m => m.id);


      // ==================================================
      // THE SPECIFIC LOGIC YOU ASKED TO KEEP
      // Querying gallery_image where is_profile is true
      // ==================================================
      const profileMap = new Map();

      if (ids.length) {
        console.log("Querying gallery_image...");
        const { data: pics, error } = await sb
          .schema("public")
          .from("gallery_image") // Singular table name
          .select("team_member_id, image_url, created_at")
          .eq("business_id", biz.id)
          .eq("is_profile", true) // The "active" profile image flag
          .in("team_member_id", ids)
          .order("created_at", { ascending: false });

        if (error) {
           console.error("Gallery query failed:", error);
        } else {
           console.log("Raw gallery data received:", pics);

           // Process into a map (keeping newest image per member)
          (pics || []).forEach(r => {
            const tm = String(r.team_member_id || "").trim();
            if (!tm) return;
            if (!profileMap.has(tm) && r.image_url) profileMap.set(tm, r.image_url);
          });
        }
      }
      // ==================================================
      // END ISOLATED LOGIC
      // ==================================================

      console.log("Final Profile Map Result:", profileMap);
    }

    runIsolatedGalleryLogic();
  </script>
</body>
</html>
